/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */

import React, { useState, useEffect, useRef } from 'react';
import { 
  Thermometer, 
  Droplets, 
  Sprout, 
  Sun, 
  Wind, 
  Power, 
  Settings, 
  Activity, 
  AlertCircle,
  Clock,
  Save,
  RefreshCw,
  Zap
} from 'lucide-react';
import { motion, AnimatePresence } from 'motion/react';
import { 
  LineChart, 
  Line, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  AreaChart,
  Area
} from 'recharts';
import { io, Socket } from 'socket.io-client';

interface SensorData {
  id?: number;
  timestamp: string;
  soil1: number;
  soil2: number;
  soil3: number;
  temp: number;
  humidity: number;
  pump1_active: number;
  pump2_active: number;
  pump3_active: number;
  light_active: number;
  vent_active: number;
}

interface SettingsData {
  soil_threshold_low_1: string;
  soil_threshold_low_2: string;
  soil_threshold_low_3: string;
  soil_threshold_high_1: string;
  soil_threshold_high_2: string;
  soil_threshold_high_3: string;
  watering_duration_1: string;
  watering_duration_2: string;
  watering_duration_3: string;
  light_off_start: string;
  light_off_end: string;
  temp_threshold_high: string;
  temp_threshold_low: string;
  hum_threshold_high: string;
  hum_threshold_low: string;
  kill_pump1: string;
  kill_pump2: string;
  kill_pump3: string;
  kill_light: string;
  kill_vent: string;
}

export default function App() {
  const [data, setData] = useState<SensorData | null>(null);
  const [history, setHistory] = useState<SensorData[]>([]);
  const [settings, setSettings] = useState<SettingsData | null>(null);
  const [editingSettings, setEditingSettings] = useState<SettingsData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [activeTab, setActiveTab] = useState<'dashboard' | 'settings' | 'controls'>('dashboard');
  const [isConnected, setIsConnected] = useState(false);
  const socketRef = useRef<Socket | null>(null);

  useEffect(() => {
    // Initialize Socket.io
    const socket = io();
    socketRef.current = socket;

    socket.on('connect', () => setIsConnected(true));
    socket.on('disconnect', () => setIsConnected(false));

    socket.on('init', (payload) => {
      setData(payload.sensors);
      setSettings(payload.settings);
      setEditingSettings(payload.settings);
      setLoading(false);
    });

    socket.on('sensor_update', (newData: SensorData) => {
      setData(newData);
      setHistory(prev => {
        const updated = [...prev, newData];
        return updated.slice(-100); // Keep last 100
      });
    });

    socket.on('settings_update', (newSettings: SettingsData) => {
      setSettings(newSettings);
    });

    // Fetch history initially
    fetch('/api/history')
      .then(res => res.json())
      .then(historyData => setHistory(historyData.reverse()));

    return () => {
      socket.disconnect();
    };
  }, []);

  const handleUpdateSetting = (key: keyof SettingsData, value: string) => {
    if (editingSettings) {
      setEditingSettings({ ...editingSettings, [key]: value });
    }
  };

  const saveSettings = async (updates: Partial<SettingsData>) => {
    setSaving(true);
    try {
      await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates),
      });
    } catch (error) {
      console.error("Failed to save settings", error);
    } finally {
      setSaving(false);
    }
  };

  const toggleKillSwitch = (key: keyof SettingsData) => {
    if (settings) {
      const newValue = settings[key] === "1" ? "0" : "1";
      saveSettings({ [key]: newValue });
    }
  };

  if (loading && !data) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <RefreshCw className="w-8 h-8 animate-spin text-emerald-500" />
          <p className="font-mono text-sm tracking-widest uppercase opacity-50">Connecting to System...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-zinc-100 font-sans selection:bg-emerald-500/30">
      {/* Header */}
      <header className="border-b border-white/5 bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 bg-emerald-500/10 rounded-lg flex items-center justify-center border border-emerald-500/20">
              <Sprout className="w-5 h-5 text-emerald-500" />
            </div>
            <div>
              <h1 className="text-sm font-bold tracking-tight uppercase">Smart Grow</h1>
              <div className="flex items-center gap-2">
                <p className="text-[10px] font-mono opacity-50 uppercase tracking-widest">v2.5.0 • Live</p>
                <div className={`w-1.5 h-1.5 rounded-full ${isConnected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`} />
              </div>
            </div>
          </div>

          <nav className="flex items-center gap-1 bg-white/5 p-1 rounded-xl border border-white/5">
            {[
              { id: 'dashboard', icon: Activity, label: 'Dashboard' },
              { id: 'controls', icon: Power, label: 'Controls' },
              { id: 'settings', icon: Settings, label: 'Settings' }
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-medium transition-all ${
                  activeTab === tab.id 
                    ? 'bg-emerald-500 text-black shadow-lg shadow-emerald-500/20' 
                    : 'text-zinc-400 hover:text-white hover:bg-white/5'
                }`}
              >
                <tab.icon className="w-3.5 h-3.5" />
                <span className="hidden sm:inline">{tab.label}</span>
              </button>
            ))}
          </nav>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        <AnimatePresence mode="wait">
          {activeTab === 'dashboard' && (
            <motion.div
              key="dashboard"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="space-y-6"
            >
              {/* Top Stats */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatCard 
                  icon={Thermometer} 
                  label="Temperature" 
                  value={`${data?.temp?.toFixed(1) || '--'}°C`} 
                  color="text-orange-500"
                  subtext={data?.vent_active ? "Ventilation Active" : "Stable"}
                />
                <StatCard 
                  icon={Droplets} 
                  label="Humidity" 
                  value={`${data?.humidity?.toFixed(1) || '--'}%`} 
                  color="text-blue-500"
                  subtext={data?.humidity && data.humidity > 70 ? "High Humidity" : "Normal"}
                />
                <StatCard 
                  icon={Sun} 
                  label="Lighting" 
                  value={data?.light_active ? "ON" : "OFF"} 
                  color={data?.light_active ? "text-yellow-400" : "text-zinc-600"}
                  subtext={`Off: ${settings?.light_off_start} - ${settings?.light_off_end}`}
                />
                <StatCard 
                  icon={Zap} 
                  label="System Status" 
                  value={isConnected ? "ONLINE" : "OFFLINE"} 
                  color={isConnected ? "text-emerald-400" : "text-red-500"}
                  subtext="WebSocket Active"
                />
              </div>

              {/* Soil Moisture Section */}
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                {[1, 2, 3].map((i) => (
                  <SoilCard 
                    key={i}
                    index={i}
                    value={(data as any)?.[`soil${i}`]}
                    isActive={(data as any)?.[`pump${i}_active`]}
                    threshold={Number((settings as any)?.[`soil_threshold_low_${i}`])}
                  />
                ))}
              </div>

              {/* Charts */}
              <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div className="bg-zinc-900/50 border border-white/5 rounded-2xl p-6">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xs font-bold uppercase tracking-widest opacity-50">Soil Moisture History</h3>
                    <div className="flex gap-4 text-[10px] font-mono">
                      <span className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-500" /> Plant 1</span>
                      <span className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-blue-500" /> Plant 2</span>
                      <span className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-purple-500" /> Plant 3</span>
                    </div>
                  </div>
                  <div className="h-[300px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <AreaChart data={history}>
                        <defs>
                          <linearGradient id="colorSoil1" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/>
                            <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                          </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" stroke="#ffffff05" vertical={false} />
                        <XAxis 
                          dataKey="timestamp" 
                          hide 
                        />
                        <YAxis 
                          stroke="#ffffff20" 
                          fontSize={10} 
                          tickFormatter={(v) => `${v}%`}
                          domain={[0, 100]}
                        />
                        <Tooltip 
                          contentStyle={{ backgroundColor: '#18181b', border: '1px solid #ffffff10', borderRadius: '8px', fontSize: '12px' }}
                          itemStyle={{ color: '#fff' }}
                        />
                        <Area type="monotone" dataKey="soil1" stroke="#10b981" fillOpacity={1} fill="url(#colorSoil1)" strokeWidth={2} isAnimationActive={false} />
                        <Area type="monotone" dataKey="soil2" stroke="#3b82f6" fillOpacity={0} strokeWidth={2} isAnimationActive={false} />
                        <Area type="monotone" dataKey="soil3" stroke="#a855f7" fillOpacity={0} strokeWidth={2} isAnimationActive={false} />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                <div className="bg-zinc-900/50 border border-white/5 rounded-2xl p-6">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xs font-bold uppercase tracking-widest opacity-50">Environment History</h3>
                    <div className="flex gap-4 text-[10px] font-mono">
                      <span className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-orange-500" /> Temp</span>
                      <span className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-cyan-500" /> Humidity</span>
                    </div>
                  </div>
                  <div className="h-[300px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={history}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#ffffff05" vertical={false} />
                        <XAxis dataKey="timestamp" hide />
                        <YAxis stroke="#ffffff20" fontSize={10} />
                        <Tooltip 
                          contentStyle={{ backgroundColor: '#18181b', border: '1px solid #ffffff10', borderRadius: '8px', fontSize: '12px' }}
                        />
                        <Line type="monotone" dataKey="temp" stroke="#f97316" strokeWidth={2} dot={false} isAnimationActive={false} />
                        <Line type="monotone" dataKey="humidity" stroke="#06b6d4" strokeWidth={2} dot={false} isAnimationActive={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </div>
            </motion.div>
          )}

          {activeTab === 'controls' && (
            <motion.div
              key="controls"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="max-w-2xl mx-auto space-y-6"
            >
              <div className="bg-zinc-900/50 border border-white/5 rounded-2xl p-8">
                <div className="flex items-center gap-3 mb-8">
                  <AlertCircle className="w-5 h-5 text-red-500" />
                  <h2 className="text-lg font-bold uppercase tracking-tight">System Kill Switches</h2>
                </div>
                
                <div className="space-y-4">
                  <KillSwitch 
                    label="Master Lighting" 
                    isActive={settings?.kill_light === "0"} 
                    onToggle={() => toggleKillSwitch('kill_light')}
                    icon={Sun}
                  />
                  <KillSwitch 
                    label="Ventilation System" 
                    isActive={settings?.kill_vent === "0"} 
                    onToggle={() => toggleKillSwitch('kill_vent')}
                    icon={Wind}
                  />
                  <div className="pt-4 border-t border-white/5 mt-4">
                    <h3 className="text-[10px] font-mono uppercase tracking-widest opacity-40 mb-4">Pump Overrides</h3>
                    <div className="grid grid-cols-1 gap-3">
                      <KillSwitch 
                        label="Pump 1 (Plant A)" 
                        isActive={settings?.kill_pump1 === "0"} 
                        onToggle={() => toggleKillSwitch('kill_pump1')}
                        icon={Droplets}
                      />
                      <KillSwitch 
                        label="Pump 2 (Plant B)" 
                        isActive={settings?.kill_pump2 === "0"} 
                        onToggle={() => toggleKillSwitch('kill_pump2')}
                        icon={Droplets}
                      />
                      <KillSwitch 
                        label="Pump 3 (Plant C)" 
                        isActive={settings?.kill_pump3 === "0"} 
                        onToggle={() => toggleKillSwitch('kill_pump3')}
                        icon={Droplets}
                      />
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          )}

          {activeTab === 'settings' && (
            <motion.div
              key="settings"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="max-w-4xl mx-auto space-y-6"
            >
              <div className="bg-zinc-900/50 border border-white/5 rounded-2xl p-8">
                <div className="flex items-center justify-between mb-8">
                  <div className="flex items-center gap-3">
                    <Settings className="w-5 h-5 text-emerald-500" />
                    <h2 className="text-lg font-bold uppercase tracking-tight">System Thresholds</h2>
                  </div>
                  <button 
                    onClick={() => editingSettings && saveSettings(editingSettings)}
                    disabled={saving}
                    className="flex items-center gap-2 px-6 py-2 bg-emerald-500 text-black rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-emerald-400 transition-colors disabled:opacity-50"
                  >
                    {saving ? <RefreshCw className="w-3 h-3 animate-spin" /> : <Save className="w-3 h-3" />}
                    Save Changes
                  </button>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  {/* Pot Specific Settings */}
                  {[1, 2, 3].map((i) => (
                    <div key={i} className="space-y-6 p-4 bg-white/5 rounded-2xl border border-white/5">
                      <h3 className="text-xs font-bold uppercase tracking-widest opacity-60 border-b border-white/5 pb-2 flex items-center gap-2">
                        <Sprout className="w-3 h-3 text-emerald-500" />
                        Plant {i} Settings
                      </h3>
                      <InputGroup 
                        label={`Low Threshold (%)`} 
                        value={(editingSettings as any)?.[`soil_threshold_low_${i}`] || ""} 
                        onChange={(v) => handleUpdateSetting(`soil_threshold_low_${i}` as any, v)}
                      />
                      <InputGroup 
                        label={`High Threshold (%)`} 
                        value={(editingSettings as any)?.[`soil_threshold_high_${i}`] || ""} 
                        onChange={(v) => handleUpdateSetting(`soil_threshold_high_${i}` as any, v)}
                      />
                      <InputGroup 
                        label={`Duration (sec)`} 
                        value={(editingSettings as any)?.[`watering_duration_${i}`] || ""} 
                        onChange={(v) => handleUpdateSetting(`watering_duration_${i}` as any, v)}
                      />
                    </div>
                  ))}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8 pt-8 border-t border-white/5">
                  <div className="space-y-6">
                    <h3 className="text-[10px] font-mono uppercase tracking-widest opacity-40 border-b border-white/5 pb-2">Environment Controls</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <InputGroup 
                        label="Temp High (°C)" 
                        value={editingSettings?.temp_threshold_high || ""} 
                        onChange={(v) => handleUpdateSetting('temp_threshold_high', v)}
                      />
                      <InputGroup 
                        label="Temp Low (°C)" 
                        value={editingSettings?.temp_threshold_low || ""} 
                        onChange={(v) => handleUpdateSetting('temp_threshold_low', v)}
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <InputGroup 
                        label="Hum High (%)" 
                        value={editingSettings?.hum_threshold_high || ""} 
                        onChange={(v) => handleUpdateSetting('hum_threshold_high', v)}
                      />
                      <InputGroup 
                        label="Hum Low (%)" 
                        value={editingSettings?.hum_threshold_low || ""} 
                        onChange={(v) => handleUpdateSetting('hum_threshold_low', v)}
                      />
                    </div>
                  </div>

                  <div className="space-y-6">
                    <h3 className="text-[10px] font-mono uppercase tracking-widest opacity-40 border-b border-white/5 pb-2">Lighting Schedule</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <InputGroup 
                        label="Light Off Start" 
                        value={editingSettings?.light_off_start || ""} 
                        onChange={(v) => handleUpdateSetting('light_off_start', v)}
                        placeholder="02:00"
                      />
                      <InputGroup 
                        label="Light Off End" 
                        value={editingSettings?.light_off_end || ""} 
                        onChange={(v) => handleUpdateSetting('light_off_end', v)}
                        placeholder="04:00"
                      />
                    </div>
                    <p className="text-[10px] opacity-30 italic">
                      The light will remain ON for 22 hours and turn OFF between the specified times.
                    </p>
                  </div>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </main>
    </div>
  );
}

function StatCard({ icon: Icon, label, value, color, subtext }: any) {
  return (
    <div className="bg-zinc-900/50 border border-white/5 rounded-2xl p-5 hover:border-white/10 transition-all">
      <div className="flex items-center gap-3 mb-3">
        <div className={`p-2 rounded-lg bg-white/5 ${color}`}>
          <Icon className="w-4 h-4" />
        </div>
        <span className="text-[10px] font-mono uppercase tracking-widest opacity-50">{label}</span>
      </div>
      <div className="text-2xl font-bold tracking-tight mb-1">{value}</div>
      <div className="text-[10px] opacity-40 font-medium">{subtext}</div>
    </div>
  );
}

function SoilCard({ index, value, isActive, threshold }: any) {
  const percentage = value || 0;
  const isLow = percentage < threshold;

  return (
    <div className="bg-zinc-900/50 border border-white/5 rounded-2xl p-6 relative overflow-hidden group">
      {isActive && (
        <motion.div 
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="absolute inset-0 bg-blue-500/5 animate-pulse"
        />
      )}
      <div className="flex items-center justify-between mb-6 relative z-10">
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-xl flex items-center justify-center border ${
            isActive ? 'bg-blue-500/20 border-blue-500/30 text-blue-400' : 'bg-white/5 border-white/5 text-zinc-500'
          }`}>
            <Droplets className={`w-5 h-5 ${isActive ? 'animate-bounce' : ''}`} />
          </div>
          <div>
            <h4 className="text-xs font-bold uppercase tracking-tight">Plant {index}</h4>
            <p className="text-[10px] font-mono opacity-40">Soil Moisture</p>
          </div>
        </div>
        <div className={`text-2xl font-mono font-bold ${isLow ? 'text-red-400' : 'text-emerald-400'}`}>
          {percentage.toFixed(0)}%
        </div>
      </div>

      <div className="space-y-2 relative z-10">
        <div className="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
          <motion.div 
            initial={{ width: 0 }}
            animate={{ width: `${percentage}%` }}
            className={`h-full rounded-full ${isLow ? 'bg-red-500' : 'bg-emerald-500'}`}
          />
        </div>
        <div className="flex justify-between text-[9px] font-mono uppercase tracking-widest opacity-40">
          <span>Dry</span>
          <span>Wet</span>
        </div>
      </div>

      {isActive && (
        <div className="mt-4 flex items-center gap-2 text-[10px] font-bold text-blue-400 uppercase tracking-widest relative z-10">
          <RefreshCw className="w-3 h-3 animate-spin" />
          Watering in progress...
        </div>
      )}
    </div>
  );
}

function KillSwitch({ label, isActive, onToggle, icon: Icon }: any) {
  return (
    <div className="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-all">
      <div className="flex items-center gap-4">
        <div className={`p-2 rounded-lg ${isActive ? 'bg-emerald-500/10 text-emerald-500' : 'bg-red-500/10 text-red-500'}`}>
          <Icon className="w-4 h-4" />
        </div>
        <div>
          <div className="text-sm font-bold tracking-tight">{label}</div>
          <div className="text-[10px] font-mono uppercase tracking-widest opacity-40">
            Status: {isActive ? 'Operational' : 'Killed'}
          </div>
        </div>
      </div>
      <button
        onClick={onToggle}
        className={`relative w-12 h-6 rounded-full transition-colors ${isActive ? 'bg-emerald-500' : 'bg-zinc-700'}`}
      >
        <motion.div 
          animate={{ x: isActive ? 26 : 4 }}
          className="absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm"
        />
      </button>
    </div>
  );
}

function InputGroup({ label, value, onChange, description, placeholder }: any) {
  return (
    <div className="space-y-1.5">
      <label className="text-[10px] font-mono uppercase tracking-widest opacity-50 block">{label}</label>
      <input 
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-emerald-500/50 transition-all font-mono"
      />
      {description && <p className="text-[10px] opacity-30 italic">{description}</p>}
    </div>
  );
}
